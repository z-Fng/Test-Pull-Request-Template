name: PR Label Notifier

on:
  pull_request:
    types: [labeled, unlabeled]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Handle label add/remove and manage comments
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const label = context.payload.label.name;

            const messages = {
              "package-request-needed": `
                PRs labeled `package-request-needed` are less likely to be reviewed and may be closed if there are no updates for a long time.\n
                Please create a [package request](https://github.com/ScoopInstaller/Extras/issues/new?assignees=&labels=package-request&projects=&template=package-request.yml&title=%5BRequest%5D%3A+) before submitting a PR to add a new package to this bucket. When creating a package request, you can check the **criteria** for a package to be accepted in this bucket, which can help you determine whether your PR is likely to be approved. The information provided in the issue can also help maintainers quickly get the necessary details.\n
                > ### For a package to be acceptable in this bucket, it should be:
                > 1. **Reasonably well-known and widely used. e.g. if it's a GitHub project, it should have at least 100 stars and/or 50 forks** *
                > 2. **English interface (or at least English documentation)** *
                > 3. **Latest stable version** *
                > 4. Full version (i.e. not a trial version)
                > 5. Fairly standard install (e.g. uses a version-specific download URL, no elaborate pre/post install scripts)
              `,
              "not-meet-criteria": `
                Thanks for your contribution to Scoop Extras bucket!\n
                Unfortunately, it appears that your package request doesn't fully meet the essential criteria.
                Please feel free to reopen this PR once it fully meets the criteria, or consider creating [your own bucket](https://github.com/ScoopInstaller/Scoop/wiki/Buckets#creating-your-own-bucket) instead.
              `
            };

            const msg = messages[label];

            if (!msg) {
              return;
            }

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: number,
            });

            const existing = comments.data.find(c =>
              c.body.trim() === msg.trim() &&
              c.user.type === "Bot"
            );

            if (!existing) {
              return;
            }

            if (context.payload.action === "labeled") {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: msg
              });
              return;
            }

            if (context.payload.action === "unlabeled") {
              await github.rest.issues.deleteComment({
                owner,
                repo,
                comment_id: existing.id
              });
              return;
            }
